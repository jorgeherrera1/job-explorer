---
import type { Job } from '../types';

interface Props {
  job: Job;
}

const { job } = Astro.props;

// Helper function to get country flags based on country names
function getCountryFlag(country: string): string {
  const flagMap: Record<string, string> = {
    'Argentina': '🇦🇷',
    'Brazil': '🇧🇷',
    'Costa Rica': '🇨🇷',
    'Mexico': '🇲🇽',
    'USA': '🇺🇸'
  };
  
  return flagMap[country] || '🌍';
}

// Regional codes based on the job's jobCodes
const regionalCodes = Object.entries(job.jobCodes).map(([country, code]) => ({
  country,
  code,
  flag: getCountryFlag(country) // Use the country name to determine flag
}));
---

<div class="h-full flex flex-col" transition:name="job-details">
  <!-- Job Header -->
  <div class="bg-white p-6 border-b border-gray-200">
    <div class="mb-6">
      <div class="text-sm text-gray-600 mb-1">Job Position</div>
      <h1 class="text-2xl font-bold text-gray-900" transition:name={`job-title-${job.id}`}>{job.jobTitle}</h1>
    </div>
    
    <!-- Grid with vertical separators -->
    <div class="grid grid-cols-3 gap-6 mb-6 relative" transition:name={`job-info-${job.id}`}>
      <div>
        <div class="text-sm text-gray-600 mb-1">Main Skill</div>
        <div class="font-semibold text-gray-900">{job.mainSkill}</div>
      </div>
      
      <!-- Vertical separator -->
      <div class="absolute left-1/3 top-0 bottom-0 w-px bg-gray-200"></div>
      
      <div>
        <div class="text-sm text-gray-600 mb-1">Level</div>
        <div class="font-semibold text-gray-900">{job.level.code}-{job.level.name}</div>
      </div>
      
      <!-- Vertical separator -->
      <div class="absolute left-2/3 top-0 bottom-0 w-px bg-gray-200"></div>
      
      <div>
        <div class="text-sm text-gray-600 mb-1">Guild</div>
        <div class="font-semibold text-gray-900">{job.guild}</div>
      </div>
    </div>

    <!-- Regional Codes -->
    <div class="mb-6" transition:name={`regional-codes-${job.id}`}>
      <div class="flex items-center gap-2 mb-3">
        <svg class="w-5 h-5 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span class="text-sm font-medium text-teal-600">Job Codes</span>
      </div>
      <div class="flex flex-wrap gap-2">
        {regionalCodes.map(({ country, code, flag }) => (
          <button 
            class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded-lg border hover:bg-gray-100 transition-colors cursor-pointer regional-code-btn"
            data-code={code}
            title={`Click to copy ${code}`}
          >
            <span class="text-lg">{flag}</span>
            <span class="text-sm font-medium text-gray-700">{code}</span>
          </button>
        ))}
      </div>
    </div>

    <!-- Tabs - Left aligned -->
    <div class="flex border-b border-gray-200" transition:name="job-tabs">
      <button 
        class="px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600 tab-button"
        data-tab="general"
      >
        General
      </button>
      <button 
        class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 tab-button"
        data-tab="responsibilities"
      >
        Main Responsibilities
      </button>
      <button 
        class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 tab-button"
        data-tab="skills"
      >
        Skills and Experience
      </button>
    </div>
  </div>

  <!-- Tab Content -->
  <div class="flex-1 overflow-y-auto p-6" transition:name={`job-content-${job.id}`}>
    <!-- General Description Tab -->
    <div id="general-tab" class="tab-content">
      <div class="flex items-center gap-2 mb-4">
        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <span class="text-sm font-medium text-blue-600">Job Description</span>
      </div>
      <div class="prose prose-sm max-w-none text-gray-700">
        <p>
          Senior II Developers work with a team to implement and deliver high-quality software solutions. Senior II developer ensure 
          that proper development processes are followed using established architectural patterns for the solution. Because of their 
          technical expertise and their experience of the business, Senior II Developers are recognized as SMEs.
        </p>
        <p class="mt-4">
          Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. 
          Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure 
          dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
        </p>
        <p class="mt-4">
          Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum. Sed ut 
          perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa 
          quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.
        </p>
      </div>
    </div>
    
    <!-- Main Responsibilities Tab -->
    <div id="responsibilities-tab" class="tab-content hidden">
      <div class="text-center py-12 text-gray-500">
        <p>Main Responsibilities content will be implemented in the future.</p>
      </div>
    </div>
    
    <!-- Skills and Experience Tab -->
    <div id="skills-tab" class="tab-content hidden">
      <div class="text-center py-12 text-gray-500">
        <p>Skills and Experience content will be implemented in the future.</p>
      </div>
    </div>
  </div>
</div>

<!-- Popover for copy confirmation -->
<div id="copy-popover" class="fixed z-50 px-3 py-2 bg-black text-white text-sm rounded-lg shadow-lg opacity-0 pointer-events-none transition-opacity duration-200" style="transform: translate(-50%, -100%);">
  <div class="flex items-center gap-2">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M5 13l4 4L19 7"></path>
    </svg>
    <span>Copied to clipboard!</span>
  </div>
  <!-- Arrow pointing down -->
  <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-black"></div>
</div>

<script>
  // Simple tab functionality
  document.addEventListener('DOMContentLoaded', () => {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    const regionalCodeButtons = document.querySelectorAll('.regional-code-btn');
    const copyPopover = document.getElementById('copy-popover');

    // Tab functionality
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const targetTab = button.getAttribute('data-tab');
        
        // Remove active state from all buttons
        tabButtons.forEach(btn => {
          btn.classList.remove('border-blue-500', 'text-blue-600');
          btn.classList.add('border-transparent', 'text-gray-500');
        });
        
        // Add active state to clicked button
        button.classList.remove('border-transparent', 'text-gray-500');
        button.classList.add('border-blue-500', 'text-blue-600');
        
        // Hide all tab contents
        tabContents.forEach(content => {
          content.classList.add('hidden');
        });
        
        // Show target tab content
        const targetContent = document.getElementById(`${targetTab}-tab`);
        if (targetContent) {
          targetContent.classList.remove('hidden');
        }
      });
    });

    // Regional code copy functionality
    regionalCodeButtons.forEach(button => {
      button.addEventListener('click', async (event) => {
        const target = event.target as HTMLElement;
        const buttonElement = target?.closest('button') as HTMLButtonElement;
        const code = buttonElement?.getAttribute('data-code');
        
        if (!code) return;
        
        try {
          // Copy to clipboard
          await navigator.clipboard.writeText(code);
          
          // Show popover
          showCopyPopover(buttonElement);
        } catch (err) {
          console.error('Failed to copy to clipboard:', err);
          // Fallback for older browsers
          fallbackCopyToClipboard(code);
          showCopyPopover(buttonElement);
        }
      });
    });

    // Function to show copy confirmation popover
    function showCopyPopover(targetButton: HTMLButtonElement | null) {
      if (!copyPopover || !targetButton) return;
      
      // Position the popover above the clicked button
      const buttonRect = targetButton.getBoundingClientRect();
      
      copyPopover.style.left = `${buttonRect.left + buttonRect.width / 2}px`;
      copyPopover.style.top = `${buttonRect.top - 10}px`;
      
      // Show popover
      copyPopover.classList.remove('opacity-0');
      copyPopover.classList.add('opacity-100');
      
      // Hide popover after 2 seconds
      setTimeout(() => {
        copyPopover.classList.remove('opacity-100');
        copyPopover.classList.add('opacity-0');
      }, 2000);
    }

    // Fallback copy function for older browsers
    function fallbackCopyToClipboard(text: string) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        document.execCommand('copy');
      } catch (err) {
        console.error('Fallback copy failed:', err);
      }
      
      document.body.removeChild(textArea);
    }
  });
</script> 