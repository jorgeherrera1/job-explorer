name: Job Explorer - CI/CD

# Trigger on pushes to main and feature/hotfix branches
trigger:
  branches:
    include:
      - main
      - feature/*
      - hotfix/*

# PR triggers for preview environments
pr:
  branches:
    include:
      - main
  autoCancel: true  # Cancel previous PR builds when new commits are pushed

variables:
  # Determine if this is the main branch
  - name: isMainBranch
    value: $[eq(variables['Build.SourceBranch'], 'refs/heads/main')]

jobs:
- job: build_and_deploy_job
  displayName: Build and Deploy Job
  condition: or(eq(variables['Build.Reason'], 'Manual'),or(eq(variables['Build.Reason'], 'PullRequest'),eq(variables['Build.Reason'], 'IndividualCI')))
  pool:
    vmImage: ubuntu-latest
  variables:
  - group: Azure-Static-Web-Apps-wonderful-glacier-0d6feda0f-variable-group
  
  steps:
  - checkout: self
    submodules: true

  # Deploy to Production (main branch only)
  - task: AzureStaticWebApp@0
    displayName: 'Deploy to Production'
    condition: eq(variables.isMainBranch, 'true')
    inputs:
      azure_static_web_apps_api_token: $(AZURE_STATIC_WEB_APPS_API_TOKEN_WONDERFUL_GLACIER_0D6FEDA0F)
      app_location: "/"
      api_location: ""
      output_location: "dist"
      # No deployment_environment = production deployment

  # Deploy to Preview Environment (feature branches and PRs)
  - task: AzureStaticWebApp@0
    displayName: 'Deploy to Preview Environment'
    name: PreviewDeploy
    condition: ne(variables.isMainBranch, 'true')
    inputs:
      azure_static_web_apps_api_token: $(AZURE_STATIC_WEB_APPS_API_TOKEN_WONDERFUL_GLACIER_0D6FEDA0F)
      app_location: "/"
      api_location: ""
      output_location: "dist"
      deployment_environment: $(Build.SourceBranchName)  # Use branch name directly for now

  # Optional: Display preview URL for easy access
  - task: PowerShell@2
    displayName: 'Display Preview Environment URL'
    condition: and(succeeded(), ne(variables.isMainBranch, 'true'))
    inputs:
      targetType: 'inline'
      script: |
        # Access the output variable from the PreviewDeploy task using the correct syntax
        $previewUrl = "$(PreviewDeploy.AZURESTATICWEBAPP_STATIC_WEB_APP_URL)"
        
        if ([string]::IsNullOrEmpty($previewUrl) -or $previewUrl -eq "`$(PreviewDeploy.AZURESTATICWEBAPP_STATIC_WEB_APP_URL)") {
          Write-Host "##[warning]Preview URL not available. This may happen if the deployment failed or the output variable was not set."
          Write-Host "##[section]üìù Environment: $(Build.SourceBranchName)"
          exit 0
        }
        
        Write-Host "##[section]üöÄ Preview Environment Deployed!"
        Write-Host "##[section]üîó URL: $previewUrl"
        Write-Host "##[section]üìù Environment: $(Build.SourceBranchName)"